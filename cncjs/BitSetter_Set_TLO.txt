; Bolt this on here so it gets defined early

%global.state.PROBE_DIAMETER = 6.35      ; Default diameter of the tool probe

; Set user-defined variables

%SAFE_HEIGHT = -1           ; clear everything height(negative number, distance below Z limit)
%PROBE_X_LOCATION = -2.5    ; machine coordinates
%PROBE_Y_LOCATION = -436.5  ; machine coordinates
%PROBE_Z_LOCATION = -100 ; See comment at end of file
%PROBE_Z_START = -30     ; machine coordinates --> lower this (more negative) to start the probing closer to wasteboard

%PROBE_TOOLCHANGE_X = -430

%PROBE_DISTANCE = 80
%PROBE_RAPID_FEEDRATE = 300 ; mm/min

; Keep a backup of current work position
%X0=posx, Y0=posy, Z0=posz

; Save modal state
%WCS = modal.wcs
%PLANE = modal.plane
%UNITS = modal.units
%DISTANCE = modal.distance
%FEEDRATE = modal.feedrate
%SPINDLE = modal.spindle
%COOLANT = modal.coolant

G21                         ; metric
M5                          ; Stop spindle
G90                         ; Absolute positioning
G49                         ; Disable TLO

G53 G0 Z[SAFE_HEIGHT]
G53 X[PROBE_TOOLCHANGE_X] Y[PROBE_Y_LOCATION]

; Pause for manual tool change & probing
%wait
M0 ; Please insert a new tool

G53 X[PROBE_X_LOCATION] Y[PROBE_Y_LOCATION]
G53 Z[PROBE_Z_START]
G91
G38.2 z-[PROBE_DISTANCE] F[PROBE_RAPID_FEEDRATE];fast probe (so it doesn't take forever)
G0 z2
G38.2 z-5 F40               ; "dial-it-in" probes
G4 P.25
G38.4 z10 F20
G4 P.25
G38.2 z-2 F10
G4 P.25
G38.4 z10 F5
G4 P.25
G90

%wait

; Update the tool length offset

%tlo = Math.round((mposz - PROBE_Z_LOCATION)*1000)/1000
(mposz = [mposz] -- tool length offset = [tlo])
G43.1 Z[tlo]

G91
G0 Z5
G90
G53 Z[SAFE_HEIGHT]

; Go to work zero at a SAFE_HEIGHT for Z
G0 X0 Y0

; Restore modal state
; [WCS]
[PLANE] [UNITS] [DISTANCE] [FEEDRATE] [SPINDLE] [COOLANT]

; PROBE_Z_LOCATION:
; ==================
; If you are always measuring tools using the BitSetter and always setting the Z zero using
; the tools you've measured, the exact Z position doesn't matter.  It's nice to get it as accurate
; as you can so that you can see a good approximation of how much tool stickout you have
; but otherwise it doesn't matter at all.
;
: However, if you have a 3D Probe that you can't measure on the bitsetter, such as:
;    https://www.amazon.com/gp/product/B0B46Y6GG7/ref=ppx_yo_dt_b_search_asin_title?ie=UTF8&psc=1
; then the PROBE_Z_LOCATION is critical to ensure that your probed height and tool heights match.
;
; In this scenario you will need a second probing mechanism.  If could be as fancy as a BitZero or as simple as:
;   https://www.amazon.com/Z-Axis-Router-Touch-Setting-Milling/dp/B07GT3CHWZ/ref=sr_1_6?crid=2VNL0S3ZSBTP1&keywords=cnc+touch&qid=1668955945&s=industrial&sprefix=cnc+touch+%2Cindustrial%2C87&sr=1-6
;
; Procedure to establish PROBE_Z_LOCATION:
;  * Set an approximate value (must be within 10mm of correct)
;  * Determine the best approximate TLO for your 3D probe and create a macro to "load" this tool with G43.1 Z___
;  * "Load" your sensor tool and place your secondary sensor somewhere (don't move it during this procedure)
; * Establish Z zero with your 3D probe on the surface of your secondary sensor
; * Run a toolchange and load an end mill using this macro
; * Move the spindle above the secondary sensor, connect any wires that need to be connected and then run
;      G38.2 Z-10 F22.5
; * The spindle should move slowly down until it touches the surface of the sensor and note the current Z value
; * Subtract the current Z value from your PROBE_Z_LOCATION (if Z is positive, Z_LOCATION goes more negative)
; * Rerun this procedure to verify that your PROBE_Z_LOCATION is now correct
