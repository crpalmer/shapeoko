; Set the diameter of our 3d probe (this is effective diameter because trigger point is not at the mid point)
%global.state.PROBE_DIAMETER=0.35
%global.state.PROBE_FEED_FAST=150
%global.state.PROBE_FEED_SLOW=10
%global.state.PROBE_DISTANCE=100

; Set user-defined variables TODO: Move to a common location!

%global.state.SAFE_HEIGHT = -5           ; clear everything height(negative number, distance below Z limit)
%global.state.PROBE_X_LOCATION = -2.5    ; machine coordinates
%global.state.PROBE_Y_LOCATION = -436.5  ; machine coordinates
%global.state.PROBE_Z_LOCATION = -30     ; machine coordinates --> lower this (more negative) to start the probing closer to wasteboard
%global.state.PROBE_PROBE_Z_LOCATION = -65
%global.state.PROBE_PROBE_DELTA_X = -13  ; distance to offset the probe location to ensure we miss the button for our touch probe
%global.state.PROBE_PROBE_DELTA_Z = 2.4  ; distance to move to get to button press position instead of case position

%global.state.PROBE_TOOLCHANGE_X = -100
%global.state.PROBE_TOOLCHANGE_Y = -440

G21                         ; metric
M5                          ; Stop spindle

G90                         ; Absolute positioning

G53 G0 Z[global.state.SAFE_HEIGHT]
G53 X[global.state.PROBE_TOOLCHANGE_X] Y[global.state.PROBE_TOOLCHANGE_Y]

; Pause for manual tool change & probing
G4 P0
M0 ; Please insert the touch probe

G53 G0 X[global.state.PROBE_X_LOCATION + global.state.PROBE_PROBE_DELTA_X] Y[global.state.PROBE_Y_LOCATION]
G53 Z[global.state.PROBE_PROBE_Z_LOCATION]

G91

G38.2 z-[global.state.PROBE_DISTANCE] F[global.state.PROBE_FEED_FAST]
G38.4 z[global.state.PROBE_DISTANCE] F[global.state.PROBE_FEED_SLOW]
G38.2 z-[global.state.PROBE_DISTANCE] F[global.state.PROBE_FEED_SLOW]

%wait
G90

%probe_end_z = Number(params.PRB.z) + global.state.PROBE_PROBE_DELTA_Z
%is_initial_tool = ! (global.state.PROBE_END_Z < 0)
%delta_z = probe_end_z - global.state.PROBE_END_Z

(old=[global.state.PROBE_END_Z] new=[probe_end_z] delta_z=[delta_z])

%global.state.PROBE_END_Z = probe_end_z

G10 L20 Z[Math.round((posz - (is_initial_tool ? 0 : delta_z)) * 10000) / 10000]

;G53 G0 Z[global.state.SAFE_HEIGHT]
;G53 X[global.state.PROBE_TOOLCHANGE_X] Y[global.state.PROBE_TOOLCHANGE_Y]
