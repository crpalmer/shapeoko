; We can only be using the tool for probing, assume 1/4"
%global.state.PROBE_DIAMETER=6.35
%global.state.PROBE_FEED_FAST=22.5
%global.state.PROBE_FEED_SLOW=10
%global.state.PROBE_DISTANCE=10

; Set user-defined variables TODO: Move to a common location!

%global.state.SAFE_HEIGHT = -5           ; clear everything height(negative number, distance below Z limit)
%global.state.PROBE_X_LOCATION = -2.5    ; machine coordinates
%global.state.PROBE_Y_LOCATION = -436.5  ; machine coordinates
%global.state.PROBE_Z_LOCATION = -30     ; machine coordinates --> lower this (more negative) to start the probing closer to wasteboard

%global.state.PROBE_TOOLCHANGE_X = -100
%global.state.PROBE_TOOLCHANGE_Y = -440

%global.state.BITSETTER_PROBE_DISTANCE = 80
%global.state.BITSETTER_PROBE_FEEDRATE = 300 ; mm/min

G21                         ; metric
M5                          ; Stop spindle

G90                         ; Absolute positioning

G53 G0 Z[global.state.SAFE_HEIGHT]
G53 X[global.state.PROBE_TOOLCHANGE_X] Y[global.state.PROBE_TOOLCHANGE_Y]

; Pause for manual tool change & probing
G4 P0
M0 ; Please insert the touch probe

G53 G0 X[global.state.PROBE_X_LOCATION] Y[global.state.PROBE_Y_LOCATION]
G53 Z[global.state.PROBE_Z_LOCATION]

G91

G38.2 z-[global.state.BITSETTER_PROBE_DISTANCE] F[global.state.BITSETTER_PROBE_FEEDRATE]
G38.4 z[global.state.PROBE_DISTANCE] F[global.state.PROBE_FEED_SLOW]
G38.2 z-[global.state.PROBE_DISTANCE] F[global.state.PROBE_FEED_SLOW]

%wait
G90

%probe_end_z = Number(params.PRB.z)
%is_initial_tool = ! (global.state.PROBE_END_Z < 0)
%delta_z = probe_end_z - global.state.PROBE_END_Z

(old=[global.state.PROBE_END_Z] new=[probe_end_z] delta_z=[delta_z])

%global.state.PROBE_END_Z = probe_end_z

G10 L20 Z[Math.round((posz - (is_initial_tool ? 0 : delta_z)) * 10000) / 10000]

; Go to work zero at a SAFE_HEIGHT for Z
G0
G53 Z[global.state.SAFE_HEIGHT]
G0 X0 Y0
